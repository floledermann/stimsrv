{% extends "base.html" %}

{% block title %}Experiment Setup for {{ experiment.name }}{% endblock %}

{% block body %}
<style>
#bangbox {
  width: 100px;
  height: 100px;
  border: 1px solid #000;
}
</style>

<section class="panel config">
<h1>{{ experiment.name }} â€“ Setup</h1>

{% if device %}
<h2>Recognized Device: {{ device.name }}</h2>
{% else %}
<h2>Device not recognized</h2>
<p>For persistent configuration, add this device to the experiment using
one of the following identifiers, or change your Client ID token:</p>
{% endif %}


<form action="/selectrole" method="post">
<p>
Your IP Address: <input type="text" class="code" value="{{ ip }}" size="40" disabled></input>
</p>
<p>
Your Client ID: <input type="text" name="clientid" class="code" value="{{ clientid }}" size="40"></input>
</p>

{% if activeRole %}
<p>
Roundtrip Time: <input id="delay-value" type="text" class="code" value="&lt;measuring...&gt;" size="14" disabled></input> ms
</p>
<p>
Timestamp adjustment: <input id="timestamp-adjust-value" name="timestamp-adjust" type="text" class="code" value="&lt;measuring...&gt;" size="14" disabled></input> ms
</p>
<p><small>
Caveat: For timing-sensitive experiments, disable "use network provided time" for phones and "set time automatically" for PCs. Otherwise the internal time of devices may change mid-experiment!
</small></p>

{% if potentialRoles.length %}
<h2>Select role of this display</h2>

<div class="radio-row">
<input type="radio" name="role" value="{{ activeRole.role }}" checked><label>{{ activeRole.description }} <small>[{{ activeRole.role }}]</small></label>
</div>

{% for role in potentialRoles %}
<div class="radio-row">
<input type="radio" name="role" value="{{ role.role }}"><label>{{ role.description }} <small>[{{ role.role }}]</small></label>
</div>
{% endfor %}

<p><small>(You can <a href="." target="_blank">open another browser window</a> to connect with additional roles)</small></p>
{% else %}
<h2>Selected role of this display:</h2>
<p>{{ activeRole.description }} <small>[{{ activeRole.role }}]</small></p>
<p><small>(Edit the experiment description to change or add roles for this device)</small></p>
{% endif %}
<button type="submit">Start</button>
{% else %}
<h2>No participation role is currently available for this device</h2>

<button type="submit">Update</button>

{% endif %}

</form>
</section>

<script src="/socket.io/socket.io.js"></script>
<script>

const socket = io.connect();
let numMeasures = 3;
let durations = [];
let lastTimestamp = null;
let timestampAdjust = 0;

function sendTime() {
  lastTimestamp = Date.now();
  socket.emit("calibrate time", {clientTimestamp: lastTimestamp});
}

socket.on("calibrate time response", (data) => {
  let duration = Date.now() - lastTimestamp;
  durations.push(duration);
  if (--numMeasures > 0) {
    window.setTimeout(sendTime, 1000);
  }
  else {
    timestampAdjust = data.serverTimestamp - lastTimestamp - Math.round(duration / 2);
    document.querySelector("#timestamp-adjust-value").value = timestampAdjust;
  }
  document.querySelector("#delay-value").value = (durations.reduce((a,b) => a+b, 0) / durations.length).toFixed(2);
});

window.setTimeout(sendTime, 3000);

</script>

{% endblock %}